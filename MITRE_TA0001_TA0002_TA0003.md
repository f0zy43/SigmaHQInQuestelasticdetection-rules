# Elastic Lucene Queries для Sysmon и Windows Events
## Отфильтрованные для тактик Initial Access, Execution, Persistence

Преобразованные запросы из MITRE ATT&CK синтаксиса в Elastic Lucene для использования в Elasticsearch.

---

## Initial Access (TA0001) - Начальный доступ

### Windows Script From Internet
```lucene
(file.extension:\"js\" OR file.extension:\"jse\" OR file.extension:\"vbs\" OR 
 file.extension:\"vbe\" OR file.extension:\"wsh\" OR file.extension:\"hta\") AND
(file.origin_url:* OR file.origin_referrer_url:*) AND
(process.name:\"chrome.exe\" OR process.name:\"msedge.exe\" OR process.name:\"explorer.exe\" OR process.name:\"winrar.exe\")
```

Обнаружение загрузки скриптов Windows с интернета через браузеры и файловый менеджер.

---

## Execution (TA0002) - Выполнение

### Windows Script From Internet
```lucene
(file.extension:\"js\" OR file.extension:\"jse\" OR file.extension:\"vbs\" OR 
 file.extension:\"vbe\" OR file.extension:\"wsh\" OR file.extension:\"hta\") AND
(file.origin_url:* OR file.origin_referrer_url:*) AND
(process.name:\"chrome.exe\" OR process.name:\"msedge.exe\" OR process.name:\"explorer.exe\" OR process.name:\"winrar.exe\")
```

Обнаружение выполнения скриптов Windows, загруженных из интернета.

### Script Execution from Browser
```lucene
(process.parent.name:\"chrome.exe\" OR process.parent.name:\"msedge.exe\" OR 
 process.parent.name:\"firefox.exe\" OR process.parent.name:\"explorer.exe\") AND
(process.name:\"wscript.exe\" OR process.name:\"mshta.exe\" OR 
 (process.name:\"cmd.exe\" AND (process.command_line:\"*.cmd*\" OR process.command_line:\"*.bat*\")))
```

Выполнение скриптов и команд, инициированное из браузера или файлового менеджера.

### Remote Thread Creation - LoadLibrary
```lucene
event.action:\"CreateRemoteThread\" AND
thread.dll.name:\"*kernel32.dll\" AND
(thread.function:\"LoadLibraryA\" OR thread.function:\"LoadLibraryW\")
```

Обнаружение создания удалённых потоков для загрузки библиотек (внедрение кода).

### PowerShell Remote Thread
```lucene
event.action:\"CreateRemoteThread\" AND
(process.name:\"powershell.exe\" OR process.name:\"pwsh.exe\") AND
NOT process.parent.name:\"CompatTelRunner.exe\"
```

PowerShell создание удалённых потоков для внедрения кода в другие процессы.

### Remote Thread to Shell
```lucene
event.action:\"CreateRemoteThread\" AND
(target_process.name:\"cmd.exe\" OR target_process.name:\"powershell.exe\" OR target_process.name:\"pwsh.exe\") AND
NOT source_process.path:\"C:\\\\Windows\\\\System32\\\\*\"
```

Внедрение кода в процессы командной оболочки из подозрительных источников.

### Process Creation (Sysmon Event 1)
```lucene
winlog.event_id:1 AND
(process.command_line:\"*powershell*\" OR process.command_line:\"*cmd.exe*\" OR process.command_line:\"*rundll32*\")
```

Мониторинг создания процессов с подозрительными командными строками.

### Process Terminated (Sysmon Event 5)
```lucene
winlog.event_id:5 AND
process.name:\"powershell.exe\"
```

Контроль завершения PowerShell процессов.

### Sysmon Image Loaded (Sysmon Event 7)
```lucene
winlog.event_id:7 AND
(image_loaded:\"*.dll\" OR image_loaded:\"*.sys\")
```

Мониторинг загрузки DLL и системных файлов.

### CreateRemoteThread (Sysmon Event 8)
```lucene
winlog.event_id:8 AND
NOT source_process.path:\"C:\\\\Windows\\\\System32\\\\*\"
```

Обнаружение создания удалённых потоков из подозрительных процессов.

### Process Creation (Event ID 4688)
```lucene
event_id:4688 AND
(process.name:\"cmd.exe\" OR process.name:\"powershell.exe\" OR process.name:\"rundll32.exe\")
```

Мониторинг создания процессов через Windows Security Events.

---

## Persistence (TA0003) - Сохранение доступа

### Firewall Rule Modification
```lucene
(event_id:2005 OR event_id:2073) AND
NOT (process.name:\"teams.exe\" OR process.name:\"keybase.exe\" OR process.name:\"Messenger.exe\")
```

Обнаружение попыток изменения правил брандмауэра для сохранения доступа.

### Scheduled Task Deletion
```lucene
event_id:4699 AND
NOT (task_name:\"*\\\\Microsoft\\\\Windows\\\\RemovalTools\\\\MRT_ERROR_HB\" OR 
     task_name:\"*\\\\Mozilla\\\\Firefox Default Browser Agent*\")
```

Мониторинг удаления запланированных задач.

### Suspicious Scheduled Task Creation
```lucene
event.action:\"process_create\" AND
process.name:\"schtasks.exe\" AND
(process.args:\"/create\" OR process.args:\"-create\") AND
NOT user.id:\"S-1-5-18\"
```

Обнаружение создания подозрительных запланированных задач для персистентности.

### Registry Run Key Modification
```lucene
registry.action:\"modification\" AND
(registry.path:\"*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\" OR
 registry.path:\"*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce\\\\*\") AND
NOT (process.name:\"explorer.exe\" OR process.name:\"svchost.exe\" OR process.name:\"msiexec.exe\")
```

Обнаружение изменений в ключах реестра Run и RunOnce для автозапуска вредоноса.

### Registry Modification (Event ID 4657)
```lucene
event_id:4657 AND
(registry.key:\"*\\\\Run\" OR registry.key:\"*\\\\RunOnce\") AND
NOT user.id:\"S-1-5-18\"
```

Мониторинг модификации реестра через Windows Security Events.

### Scheduled Task Registered (Event ID 4698)
```lucene
event_id:4698 AND
(task.name:\"*\\\\Microsoft\\\\Windows\\\\*\" OR task.name:\"*Scheduled\\\\*\")
```

Мониторинг регистрации запланированных задач.

### Suspicious File Extension Changes
```lucene
event.action:\"FileRename\" AND
(file.extension:\"dll\" OR file.extension:\"exe\" OR file.extension:\"bat\" OR file.extension:\"ps1\") AND
NOT source_file.extension:\"exe\"
```

Обнаружение подозрительного переименования файлов для скрытия вредоносов.

### Dump File Creation
```lucene
event.action:\"FileCreate\" AND
(file.extension:\"dmp\" OR file.extension:\"dump\" OR file.extension:\"hdmp\")
```

Мониторинг создания дамп-файлов процессов (возможный сбор учетных данных).

---

## General Sysmon Event Mappings

### File Created Time Changed (Sysmon Event 2)
```lucene
winlog.event_id:2 AND file.name:\"*.exe\"
```

Обнаружение изменения времени создания файлов .exe.

### Network Connection Initiated (Sysmon Event 3)
```lucene
winlog.event_id:3 AND
(destination.port:53 OR destination.port:80 OR destination.port:443) AND
process.name:\"powershell.exe\"
```

Мониторинг сетевых соединений из PowerShell на подозрительные порты.

---

## Windows Security Event Mappings

### Logon Event (Event ID 4624)
```lucene
event_id:4624 AND
(logon_type:3 OR logon_type:10) AND
NOT user.domain:\"NT AUTHORITY\"
```

Мониторинг успешных входов через сеть или удаленный рабочий стол.

### Account Modification (Event ID 4720-4730)
```lucene
(event_id:4720 OR event_id:4722 OR event_id:4725 OR event_id:4726 OR event_id:4738) AND
NOT user.id:\"S-1-5-18\"
```

Мониторинг изменений учетных записей для сохранения доступа.

### Object Access - File (Event ID 4663)
```lucene
event_id:4663 AND
object.type:\"File\" AND
(object.name:\"*credential*\" OR object.name:\"*password*\" OR object.name:\"*.pst\")
```

Обнаружение доступа к файлам с учетными данными.

---

## Notes (Примечания)

- Запросы адаптированы для использования в **Kibana Query Language (KQL)** и **Elasticsearch Query DSL**
- Временные диапазоны и условия могут быть скорректированы в зависимости от вашей инфраструктуры
- Рекомендуется тестировать все запросы в тестовой среде перед применением в production
- Используйте поле `host.os.type:\"windows\"` для фильтрации только Windows событий
- Поле `event_id` или `winlog.event_id` зависит от конфигурации Filebeat/Winlogbeat

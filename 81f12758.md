# Отчёты по инцидентам безопасности
Составлены на основе тактик MITRE ATT&CK для Sysmon мониторинга

---

## 1. Windows Script From Internet (TA0001 - Initial Access)

**Что произошло:** Загрузка и выполнение скриптов Windows, загруженных с интернета через браузеры

**УРОВЕНЬ УГРОЗЫ:** ВЫСОКИЙ  
**время:** [@timestamp]  
**хост:** [host.name]  
**процесс:** [process.parent.name]  
**расширение файла:** [*.js, *.jse, *.vbs, *.vbe, *.wsh, *.hta]  

**Описание:**

Обнаружен запуск скрипта Windows, который был загружен из интернета через браузер или файловый менеджер. Это типичный вектор атаки для доставки вредоноса. Скрипты такого типа часто используются для выполнения вредоносного кода с минимальными подозрениями пользователя.

**IOC:**
1. Запуск файлов с расширениями: .js, .jse, .vbs, .vbe, .wsh, .hta
2. Родительский процесс: браузер (chrome.exe, msedge.exe, firefox.exe) или explorer.exe
3. Недавняя загрузка из интернета (проверить history браузера и папку Downloads)

**Пользователь:** Обычный пользователь (непривилегированный)

**ТЕХНИКА MITRE:** T1204.002 - User Execution: Malicious File

**KQL запрос:**
```lucene
winlog.event_id:1 AND
(process.command_line:"*.js" OR process.command_line:"*.jse" OR process.command_line:"*.vbs" OR 
 process.command_line:"*.vbe" OR process.command_line:"*.wsh" OR process.command_line:"*.hta") AND
(process.parent.name:"chrome.exe" OR process.parent.name:"msedge.exe" OR 
 process.parent.name:"explorer.exe" OR process.parent.name:"winrar.exe")
```

---

## 2. Script Execution from Browser (TA0002 - Execution)

**Что произошло:** Выполнение скриптов и команд, инициированное из браузера или файлового менеджера

**УРОВЕНЬ УГРОЗЫ:** ВЫСОКИЙ  
**время:** [@timestamp]  
**хост:** [host.name]  
**родительский процесс:** [process.parent.name]  
**дочерний процесс:** [process.name]  

**Описание:**

Обнаружено выполнение скрипт-интерпретаторов (wscript.exe, cscript.exe, mshta.exe) или команд оболочки (cmd.exe) из браузера. Это свидетельствует о попытке выполнения вредоносного кода, загруженного с веб-сайта. Такие процессы обычно не запускаются из браузеров в нормальной деятельности.

**IOC:**
1. Родительский процесс: chrome.exe, msedge.exe, firefox.exe, explorer.exe
2. Дочерний процесс: wscript.exe, mshta.exe, cscript.exe, cmd.exe
3. Командная строка содержит подозрительные параметры

**Пользователь:** Обычный пользователь или администратор

**ТЕХНИКА MITRE:** T1059 - Command and Scripting Interpreter

**KQL запрос:**
```lucene
winlog.event_id:1 AND
(process.parent.name:"chrome.exe" OR process.parent.name:"msedge.exe" OR 
 process.parent.name:"firefox.exe" OR process.parent.name:"explorer.exe") AND
(process.name:"wscript.exe" OR process.name:"mshta.exe" OR process.name:"cscript.exe" OR
 (process.name:"cmd.exe" AND (process.command_line:"*.cmd*" OR process.command_line:"*.bat*")))
```

---

## 3. Remote Thread Creation - LoadLibrary (TA0002 - Execution)

**Что произошло:** Создание удалённых потоков для загрузки библиотек (внедрение кода)

**УРОВЕНЬ УГРОЗЫ:** КРИТИЧЕСКИЙ  
**время:** [@timestamp]  
**хост:** [host.name]  
**исходный процесс:** [source_process.name]  
**целевой процесс:** [target_process.name]  
**функция:** [LoadLibraryA/LoadLibraryW]  

**Описание:**

Обнаружено создание удалённого потока в другом процессе с использованием функций LoadLibraryA или LoadLibraryW из kernel32.dll. Это является техникой внедрения кода (code injection) и позволяет злоумышленнику выполнять произвольный код в контексте целевого процесса. Такая активность редко встречается при легитимном использовании системы.

**IOC:**
1. Создание удалённого потока через CreateRemoteThread
2. Загрузка kernel32.dll с вызовом LoadLibrary функций
3. Внедрение в системные процессы (svchost.exe, explorer.exe и т.д.)

**Пользователь:** Атакующий с повышенными привилегиями или пользователь, заражённый вредоносом

**ТЕХНИКА MITRE:** T1055.001 - Process Injection: Dynamic-link Library Injection

**KQL запрос:**
```lucene
winlog.event_id:8 AND
thread.dll.name:"*kernel32.dll" AND
(thread.function:"LoadLibraryA" OR thread.function:"LoadLibraryW")
```

---

## 4. PowerShell Remote Thread (TA0002 - Execution)

**Что произошло:** PowerShell создание удалённых потоков для внедрения кода в другие процессы

**УРОВЕНЬ УГРОЗЫ:** КРИТИЧЕСКИЙ  
**время:** [@timestamp]  
**хост:** [host.name]  
**процесс:** [powershell.exe/pwsh.exe]  
**целевой процесс:** [target_process.name]  

**Описание:**

PowerShell используется для создания удалённых потоков в других процессах. Это указывает на использование инструмента для внедрения кода и достижения целей атаки. PowerShell часто используется в cyberattacks благодаря своей мощности и встроенным функциям для манипуляции системой.

**IOC:**
1. Процесс powershell.exe или pwsh.exe создающий удалённые потоки
2. Вызовы CreateRemoteThread в Event ID 8
3. Целевые процессы: svchost.exe, explorer.exe, lsass.exe

**Пользователь:** Администратор, скомпрометированный пользователь или атакующий

**ТЕХНИКА MITRE:** T1055 - Process Injection

**KQL запрос:**
```lucene
winlog.event_id:8 AND
(source_process.name:"powershell.exe" OR source_process.name:"pwsh.exe") AND
NOT source_process.parent.name:"CompatTelRunner.exe"
```

---

## 5. Remote Thread to Shell (TA0002 - Execution)

**Что произошло:** Внедрение кода в процессы командной оболочки из подозрительных источников

**УРОВЕНЬ УГРОЗЫ:** КРИТИЧЕСКИЙ  
**время:** [@timestamp]  
**хост:** [host.name]  
**исходный процесс:** [source_process.name]  
**целевой процесс:** [cmd.exe/powershell.exe/pwsh.exe]  

**Описание:**

Обнаружено внедрение кода в командные оболочки (cmd.exe, powershell.exe, pwsh.exe) из процесса, находящегося вне системной папки System32. Это позволяет атакующему выполнять произвольные команды с привилегиями целевого процесса. Внедрение в оболочки особенно опасно, так как даёт полный контроль над системой.

**IOC:**
1. CreateRemoteThread в процессы cmd.exe, powershell.exe, pwsh.exe
2. Исходный процесс вне C:\Windows\System32\
3. Процессы из временных папок, AppData или других подозрительных мест

**Пользователь:** Атакующий, вредонос или скомпрометированный пользователь

**ТЕХНИКА MITRE:** T1055 - Process Injection

**KQL запрос:**
```lucene
winlog.event_id:8 AND
(target_process.name:"cmd.exe" OR target_process.name:"powershell.exe" OR target_process.name:"pwsh.exe") AND
NOT source_process.path:"C:\\Windows\\System32\\*"
```

---

## 6. Process Creation with Suspicious Commands (TA0002 - Execution)

**Что произошло:** Создание процессов с подозрительными командными строками и LOLBins утилитами

**УРОВЕНЬ УГРОЗЫ:** ВЫСОКИЙ  
**время:** [@timestamp]  
**хост:** [host.name]  
**процесс:** [process.name]  
**командная строка:** [process.command_line]  

**Описание:**

Обнаружено создание процесса с использованием подозрительных утилит операционной системы (Living Off The Land Binaries - LOLBins), которые часто используются в cyberattacks для выполнения вредоносного кода без использования новых исполняемых файлов. К таким утилитам относятся: powershell.exe, cmd.exe, rundll32.exe, regsvcs.exe, regasm.exe, wmic.exe, msiexec.exe, bitsadmin.exe.

**IOC:**
1. Утилиты: powershell, cmd.exe, rundll32, regsvcs, regasm, wmic, msiexec, bitsadmin
2. Подозрительные параметры командной строки (особенно с кодированием или скрытием)
3. Создание из непривычных источников (веб-браузеры, документы Office)

**Пользователь:** Администратор, скомпрометированный пользователь или атакующий

**ТЕХНИКА MITRE:** T1059 - Command and Scripting Interpreter, T1218 - Signed Binary Proxy Execution

**KQL запрос:**
```lucene
winlog.event_id:1 AND
(process.command_line:"*powershell*" OR process.command_line:"*cmd.exe*" OR process.command_line:"*rundll32*" OR
 process.command_line:"*regsvcs*" OR process.command_line:"*regasm*" OR process.command_line:"*wmic*" OR
 process.command_line:"*msiexec*" OR process.command_line:"*bitsadmin*")
```

---

## 7. File Created Time Changed (TA0002 - Execution)

**Что произошло:** Изменение времени создания исполняемых файлов (маскировка активности)

**УРОВЕНЬ УГРОЗЫ:** СРЕДНИЙ  
**время:** [@timestamp]  
**хост:** [host.name]  
**файл:** [file.name]  
**исходный процесс:** [process.name]  

**Описание:**

Обнаружено изменение меток времени создания файлов (файлы .exe, .dll, .sys, .bat, .ps1). Это техника, используемая злоумышленниками для маскировки времени появления вредоносных файлов и затруднения форензического анализа. Изменение временных меток редко выполняется легитимными приложениями.

**IOC:**
1. Event ID 2 (SetFileTime) в Sysmon
2. Файлы исполняемых типов: .exe, .dll, .sys, .bat, .ps1
3. Изменение атрибутов файлов из подозрительных процессов

**Пользователь:** Администратор или атакующий с повышенными привилегиями

**ТЕХНИКА MITRE:** T1070.006 - Indicator Removal: Timestomp

**KQL запрос:**
```lucene
winlog.event_id:2 AND 
(file.name:"*.exe" OR file.name:"*.dll" OR file.name:"*.sys" OR file.name:"*.bat" OR file.name:"*.ps1")
```

---

## 8. Network Connection - PowerShell (TA0002 - Execution)

**Что произошло:** Мониторинг сетевых соединений из PowerShell на стандартные HTTP/HTTPS/DNS порты

**УРОВЕНЬ УГРОЗЫ:** ВЫСОКИЙ  
**время:** [@timestamp]  
**хост:** [host.name]  
**процесс:** [powershell.exe/pwsh.exe]  
**целевой адрес:** [destination.ip]  
**целевой порт:** [destination.port]  

**Описание:**

PowerShell устанавливает сетевое соединение на стандартные веб-порты (80 - HTTP, 443 - HTTPS, 53 - DNS). Это может указывать на попытку доступа к вредоносному серверу, загрузку вредоноса или связь с командным центром (C2). PowerShell часто используется для удаления файлов и взаимодействия с сетью в cyberattacks.

**IOC:**
1. Процесс: powershell.exe или pwsh.exe
2. Порты: 80, 443, 53 (или нестандартные, если используется туннелирование)
3. Направление: outbound соединения
4. Целевые IP адреса из подозрительных сетей

**Пользователь:** Администратор, скомпрометированный пользователь

**ТЕХНИКА MITRE:** T1105 - Ingress Tool Transfer

**KQL запрос:**
```lucene
winlog.event_id:3 AND
(source_process.name:"powershell.exe" OR source_process.name:"pwsh.exe") AND
(destination.port:80 OR destination.port:443 OR destination.port:53)
```

---

## 9. DLL/Module Load by Suspicious Process (TA0002 - Execution)

**Что произошло:** Обнаружение загрузки DLL файлов подозрительными процессами

**УРОВЕНЬ УГРОЗЫ:** ВЫСОКИЙ  
**время:** [@timestamp]  
**хост:** [host.name]  
**процесс:** [process.name]  
**загруженная DLL:** [image_loaded]  

**Описание:**

Обнаружена загрузка DLL файлов подозрительными процессами (powershell.exe, cmd.exe, wscript.exe, cscript.exe, mshta.exe, rundll32.exe, regsvr32.exe). Эти процессы обычно используют ограниченный набор библиотек, поэтому загрузка неожиданных DLL может указывать на внедрение кода или использование техник маскировки.

**IOC:**
1. Процессы: powershell.exe, cmd.exe, wscript.exe, cscript.exe, mshta.exe, rundll32.exe, regsvr32.exe
2. Загруженные DLL/SYS файлы из неожиданных мест
3. DLL из временных папок (%TEMP%, %AppData%)

**Пользователь:** Администратор, скомпрометированный пользователь, атакующий

**ТЕХНИКА MITRE:** T1129 - Shared Modules

**KQL запрос:**
```lucene
winlog.event_id:7 AND
(process.name:"powershell.exe" OR process.name:"pwsh.exe" OR process.name:"cmd.exe" OR
 process.name:"wscript.exe" OR process.name:"cscript.exe" OR process.name:"mshta.exe" OR
 process.name:"rundll32.exe" OR process.name:"regsvr32.exe") AND
(image_loaded:"*.dll" OR image_loaded:"*.sys")
```

---

## 10. Dbghelp/Dbgcore Load by Suspicious Process (TA0002 - Execution)

**Что произошло:** Обнаружение загрузки отладочных библиотек для манипуляции памятью

**УРОВЕНЬ УГРОЗЫ:** КРИТИЧЕСКИЙ  
**время:** [@timestamp]  
**хост:** [host.name]  
**процесс:** [process.name]  
**загруженная библиотека:** [dbghelp.dll/dbgcore.dll]  

**Описание:**

Обнаружена загрузка отладочных библиотек (dbghelp.dll или dbgcore.dll) подозрительными процессами. Эти библиотеки используются для доступа к памяти процессов и часто применяются для кражи учетных данных, включая извлечение хешей паролей и билетов Kerberos. Загрузка этих DLL из подозрительных процессов - сигнал возможной попытки credential dumping.

**IOC:**
1. Загруженные библиотеки: dbghelp.dll, dbgcore.dll
2. Процессы: bash.exe, cmd.exe, cscript.exe, powershell.exe, rundll32.exe, wscript.exe
3. Взаимодействие с процессом lsass.exe

**Пользователь:** Администратор или атакующий с повышенными привилегиями

**ТЕХНИКА MITRE:** T1036.003 - Masquerading: Rename System Utilities, T1557 - Man-in-the-Middle

**KQL запрос:**
```lucene
winlog.event_id:7 AND
(image_loaded:"*dbghelp.dll" OR image_loaded:"*dbgcore.dll") AND
(process.name:"bash.exe" OR process.name:"cmd.exe" OR process.name:"cscript.exe" OR
 process.name:"powershell.exe" OR process.name:"rundll32.exe" OR process.name:"wscript.exe")
```

---

## 11. WMI Module Load (TA0002 - Execution)

**Что произошло:** Обнаружение использования WMI для выполнения команд из подозрительных процессов

**УРОВЕНЬ УГРОЗЫ:** ВЫСОКИЙ  
**время:** [@timestamp]  
**хост:** [host.name]  
**процесс:** [process.name]  
**загруженная DLL:** [fastprox.dll/wbemcomn.dll/и др.]  

**Описание:**

Обнаружена загрузка WMI-связанных библиотек (fastprox.dll, wbemcomn.dll, wbemprox.dll, wbemsvc.dll, WmiApRpl.dll, wmiprov.dll) из процессов, находящихся вне стандартных системных папок. WMI используется для выполнения удалённых команд, создания процессов и установки persistence механизмов. Такая активность указывает на попытку выполнения команд через WMI.

**IOC:**
1. WMI DLL: fastprox.dll, wbemcomn.dll, wbemprox.dll, wbemsvc.dll, WmiApRpl.dll, wmiprov.dll
2. Процесс вне Program Files или System32
3. Использование wmic.exe с подозрительными параметрами

**Пользователь:** Администратор или атакующий с повышенными привилегиями

**ТЕХНИКА MITRE:** T1047 - Windows Management Instrumentation

**KQL запрос:**
```lucene
winlog.event_id:7 AND
(image_loaded:"*fastprox.dll" OR image_loaded:"*wbemcomn.dll" OR image_loaded:"*wbemprox.dll" OR
 image_loaded:"*wbemsvc.dll" OR image_loaded:"*WmiApRpl.dll" OR image_loaded:"*wmiprov.dll") AND
NOT (process.path:"C:\\Program Files*" OR process.path:"C:\\Windows\\System32\\*")
```

---

## 12. AMSI Bypass via DLL Load (TA0002 - Execution)

**Что произошло:** Обнаружение загрузки AMSI библиотеки подозрительными процессами (попытка обхода защиты)

**УРОВЕНЬ УГРОЗЫ:** КРИТИЧЕСКИЙ  
**время:** [@timestamp]  
**хост:** [host.name]  
**процесс:** [process.name]  
**загруженная DLL:** [amsi.dll]  

**Описание:**

Обнаружена загрузка amsi.dll (Windows Antimalware Scan Interface) подозрительными процессами, которые не должны с ней взаимодействовать (вне explorer.exe, System процессов и Program Files). Это может указывать на попытку обхода AMSI защиты для выполнения вредоносного кода без обнаружения. AMSI отвечает за сканирование скриптов и исполняемого кода перед выполнением.

**IOC:**
1. Загруженная библиотека: amsi.dll
2. Процесс вне explorer.exe, System, Program Files, Windows\System32
3. Использование техник reflection или inline assembly для обхода

**Пользователь:** Администратор, скомпрометированный пользователь, атакующий

**ТЕХНИКА MITRE:** T1562.001 - Impair Defenses: Disable or Modify Tools

**KQL запрос:**
```lucene
winlog.event_id:7 AND
image_loaded:"*amsi.dll" AND
NOT (process.name:"explorer.exe" OR process.name:"Sysmon64.exe" OR
     process.path:"C:\\Program Files*" OR process.path:"C:\\Windows\\System32\\*")
```

---

## 13. Office XLL/WLL Add-in Load (TA0002 - Execution)

**Что произошло:** Обнаружение загрузки вредоносных расширений в Office приложениях

**УРОВЕНЬ УГРОЗЫ:** ВЫСОКИЙ  
**время:** [@timestamp]  
**хост:** [host.name]  
**приложение Office:** [excel.exe/winword.exe]  
**загруженное расширение:** [*.xll/*.wll]  

**Описание:**

Обнаружена загрузка добавок XLL (Excel Add-in Library) или WLL (Word Add-in Library) в Office приложениях. Эти расширения содержат нативный код и выполняются с привилегиями приложения Office. Вредоносные XLL/WLL могут использоваться для выполнения произвольного кода при открытии документа или запуске приложения Office.

**IOC:**
1. Приложения: excel.exe, winword.exe
2. Файлы: .xll (для Excel), .wll (для Word)
3. Расположение: документы, временные папки, сетевые ресурсы
4. Признаки: странные расширения, файлы из интернета

**Пользователь:** Пользователь, открывший вредоносный документ

**ТЕХНИКА MITRE:** T1137.006 - Office Application Startup: Add-ins

**KQL запрос:**
```lucene
winlog.event_id:7 AND
((process.name:"excel.exe" AND image_loaded:"*.xll") OR
 (process.name:"winword.exe" AND image_loaded:"*.wll"))
```

---

## 14. Process Accessed - Credential Dumping (TA0002 - Execution)

**Что произошло:** Обнаружение попыток доступа к процессу lsass.exe для извлечения учетных данных

**УРОВЕНЬ УГРОЗЫ:** КРИТИЧЕСКИЙ  
**время:** [@timestamp]  
**хост:** [host.name]  
**целевой процесс:** [lsass.exe]  
**исходный процесс:** [process.name]  

**Описание:**

Обнаружена попытка доступа к процессу lsass.exe (Local Security Authority Subsystem Service) из подозрительного источника. LSASS хранит учетные данные пользователей в памяти. Доступ к этому процессу часто используется для извлечения хешей паролей и билетов Kerberos с использованием утилит, подобных Mimikatz.

**IOC:**
1. Целевой процесс: lsass.exe
2. Исходные процессы: powershell.exe, cmd.exe, mimikatz.exe, процессы из Temp папок
3. Флаги доступа: PROCESS_VM_READ, PROCESS_QUERY_INFORMATION

**Пользователь:** Администратор или атакующий с повышенными привилегиями

**ТЕХНИКА MITRE:** T1110 - Brute Force, T1555 - Credentials from Password Stores

**KQL запрос:**
```lucene
winlog.event_id:10 AND
target_process.name:"lsass.exe" AND
(source_process.name:"powershell.exe" OR source_process.name:"cmd.exe" OR 
 source_process.name:"mimikatz.exe" OR source_process.path:"*\\Temp\\*")
```

---

## 15. Process Terminated - Suspicious (TA0002 - Execution)

**Что произошло:** Контроль завершения PowerShell процессов для анализа сессий

**УРОВЕНЬ УГРОЗЫ:** СРЕДНИЙ  
**время:** [@timestamp]  
**хост:** [host.name]  
**процесс:** [powershell.exe]  
**код выхода:** [exit_code]  

**Описание:**

Обнаружено завершение процесса powershell.exe. Хотя само по себе завершение PowerShell не является подозрительным, контекст (частое завершение/перезапуск, завершение из подозрительного источника) может указывать на попытку сокрытия деятельности или завершение сессии после выполнения вредоносных команд.

**IOC:**
1. Процесс: powershell.exe
2. Частые завершения и перезапуски
3. Завершение из неожиданного родительского процесса
4. Аномальные коды выхода

**Пользователь:** Администратор, пользователь, атакующий

**ТЕХНИКА MITRE:** T1562 - Impair Defenses

**KQL запрос:**
```lucene
winlog.event_id:5 AND
process.name:"powershell.exe"
```

---

## 16. Registry Run Key Modification (TA0003 - Persistence)

**Что произошло:** Обнаружение изменений в ключах реестра Run и RunOnce для автозапуска вредоноса

**УРОВЕНЬ УГРОЗЫ:** ВЫСОКИЙ  
**время:** [@timestamp]  
**хост:** [host.name]  
**ключ реестра:** [registry.path]  
**значение:** [registry.value]  

**Описание:**

Обнаружено изменение ключей реестра Run или RunOnce для установки persistence механизма. Эти ключи используются Windows для автоматического запуска программ при загрузке системы или входе пользователя. Вредоносное ПО добавляет себя в эти ключи для обеспечения автоматического запуска при перезагрузке.

**IOC:**
1. Ключи реестра: HKLM\Software\Microsoft\Windows\CurrentVersion\Run\* или RunOnce\*
2. Значения из подозрительных мест: %Temp%, %AppData%, сетевые ресурсы
3. Исходный процесс вне System32, Program Files, svchost.exe, explorer.exe

**Пользователь:** Администратор, скомпрометированный пользователь, вредонос

**ТЕХНИКА MITRE:** T1547.001 - Boot or Logon Autostart Execution: Registry Run Keys / Startup Folder

**KQL запрос:**
```lucene
winlog.event_id:(12 OR 13) AND
(registry.path:"*\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\*" OR
 registry.path:"*\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce\\*" OR
 registry.path:"*\\Software\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Run\\*") AND
NOT (process.name:"explorer.exe" OR process.name:"svchost.exe" OR process.name:"msiexec.exe" OR
     process.path:"C:\\Program Files*" OR process.path:"C:\\Windows\\System32\\*")
```

---

## 17. Registry Run Key Set (TA0003 - Persistence)

**Что произошло:** Обнаружение создания сервисов и драйверов через реестр для персистентности

**УРОВЕНЬ УГРОЗЫ:** КРИТИЧЕСКИЙ  
**время:** [@timestamp]  
**хост:** [host.name]  
**путь реестра:** [registry.path]  
**тип значения:** [registry.value.type]  

**Описание:**

Обнаружено создание или изменение ключей реестра для сервисов и драйверов (HKLM\System\CurrentControlSet\Services\*). Это позволяет установить persistence на уровне ядра с привилегиями SYSTEM. Вредоносные драйверы выполняются с самыми высокими привилегиями и перезагружаются автоматически.

**IOC:**
1. Пути реестра: Services\* или Drivers\*
2. Типы значений: REG_SZ, REG_EXPAND_SZ с путями к исполняемым файлам
3. Параметры: ImagePath, Start (значение 2 или 3 для автозапуска)

**Пользователь:** Администратор или атакующий с привилегиями SYSTEM

**ТЕХНИКА MITRE:** T1547.011 - Boot or Logon Autostart Execution: Services

**KQL запрос:**
```lucene
winlog.event_id:13 AND
(registry.path:"*\\Services\\*" OR registry.path:"*\\Drivers\\*") AND
(registry.value.type:"REG_SZ" OR registry.value.type:"REG_EXPAND_SZ")
```

---

## 18. File Created in System Directories (TA0003 - Persistence)

**Что произошло:** Обнаружение создания подозрительных файлов в системных директориях

**УРОВЕНЬ УГРОЗЫ:** ВЫСОКИЙ  
**время:** [@timestamp]  
**хост:** [host.name]  
**файл:** [file.path]  
**создавший процесс:** [process.name]  

**Описание:**

Обнаружено создание исполняемых, скриптовых или системных файлов в системных директориях (System32, SysWOW64, ProgramData) из процесса, который не должен туда писать. Это может указывать на попытку замены системных файлов, установку persistence механизма или распространение вредоноса.

**IOC:**
1. Директории: C:\Windows\System32\*, C:\Windows\SysWOW64\*, C:\ProgramData\*
2. Типы файлов: .exe, .dll, .sys, .scr, .bat, .ps1, .vbs
3. Исходный процесс вне System, svchost.exe, explorer.exe или System32

**Пользователь:** Администратор, скомпрометированный пользователь, атакующий

**ТЕХНИКА MITRE:** T1542 - Pre-OS Boot

**KQL запрос:**
```lucene
winlog.event_id:11 AND
(file.path:"C:\\Windows\\System32\\*" OR file.path:"C:\\Windows\\SysWOW64\\*" OR
 file.path:"C:\\ProgramData\\*") AND
(file.extension:"exe" OR file.extension:"dll" OR file.extension:"sys" OR file.extension:"scr" OR
 file.extension:"bat" OR file.extension:"ps1" OR file.extension:"vbs") AND
NOT (process.name:"svchost.exe" OR process.name:"System" OR process.path:"C:\\Windows\\System32\\*")
```

---

## 19. File Creation in Startup Directory (TA0003 - Persistence)

**Что произошло:** Обнаружение создания вредоносных файлов в папке Startup для автозапуска

**УРОВЕНЬ УГРОЗЫ:** ВЫСОКИЙ  
**время:** [@timestamp]  
**хост:** [host.name]  
**файл:** [file.path]  
**расширение:** [file.extension]  

**Описание:**

Обнаружено создание исполняемых или скриптовых файлов в папке Startup, которая используется для автоматического запуска программ при входе пользователя. Вредоносное ПО часто использует эту папку для обеспечения persistence. Файлы в Startup запускаются с привилегиями пользователя при каждом входе.

**IOC:**
1. Пути: %AppData%\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\* или похожие
2. Типы файлов: .exe, .dll, .bat, .ps1, .vbs
3. Создание из браузеров, документов, интернета

**Пользователь:** Пользователь, вредонос, скомпрометированная учётная запись

**ТЕХНИКА MITRE:** T1547.001 - Boot or Logon Autostart Execution: Registry Run Keys / Startup Folder

**KQL запрос:**
```lucene
winlog.event_id:11 AND
(file.path:"*\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\*" OR
 file.path:"*\\AppData\\Roaming\\Microsoft\\Windows\\StartMenu\\Programs\\Startup\\*" OR
 file.path:"*\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\*") AND
(file.extension:"exe" OR file.extension:"dll" OR file.extension:"bat" OR file.extension:"ps1" OR file.extension:"vbs")
```

---

## 20. Scheduled Task Creation (TA0003 - Persistence)

**Что произошло:** Обнаружение создания запланированных задач для выполнения вредоноса

**УРОВЕНЬ УГРОЗЫ:** ВЫСОКИЙ  
**время:** [@timestamp]  
**хост:** [host.name]  
**утилита:** [schtasks.exe]  
**команда:** [process.command_line]  

**Описание:**

Обнаружено использование утилиты schtasks.exe для создания запланированной задачи. Запланированные задачи могут быть использованы для выполнения вредоносного кода в определённое время или при определённых условиях, обеспечивая persistence. Создание задач из непривилегированного пользователя подозрительно.

**IOC:**
1. Процесс: schtasks.exe
2. Параметры: /create, -create
3. Пользователь: не SYSTEM (S-1-5-18)
4. Командная строка с подозрительными параметрами

**Пользователь:** Администратор, скомпрометированный пользователь, вредонос

**ТЕХНИКА MITRE:** T1053.005 - Scheduled Task/Job: Scheduled Task

**KQL запрос:**
```lucene
winlog.event_id:1 AND
process.name:"schtasks.exe" AND
(process.command_line:"*/create*" OR process.command_line:"-create") AND
NOT user.id:"S-1-5-18"
```

---

## 21. Scheduled Task Deletion (TA0003 - Persistence)

**Что произошло:** Обнаружение удаления запланированных задач для скрытия своей деятельности

**УРОВЕНЬ УГРОЗЫ:** СРЕДНИЙ  
**время:** [@timestamp]  
**хост:** [host.name]  
**утилита:** [schtasks.exe]  
**команда:** [process.command_line]  

**Описание:**

Обнаружено использование schtasks.exe для удаления запланированных задач. Злоумышленники часто удаляют задачи для сокрытия доказательств своей деятельности или отката перед включением защиты. Удаление задач из непривилегированного пользователя подозрительно.

**IOC:**
1. Процесс: schtasks.exe
2. Параметры: /delete, -delete
3. Пользователь: не SYSTEM
4. Частое удаление нескольких задач

**Пользователь:** Администратор, скомпрометированный пользователь, вредонос

**ТЕХНИКА MITRE:** T1562.001 - Impair Defenses: Disable or Modify Tools

**KQL запрос:**
```lucene
winlog.event_id:1 AND
process.name:"schtasks.exe" AND
(process.command_line:"*/delete*" OR process.command_line:"-delete") AND
NOT user.id:"S-1-5-18"
```

---

## 22. WMI Event Subscription for Persistence (TA0003 - Persistence)

**Что произошло:** Обнаружение использования WMI для создания постоянных событий (персистентность)

**УРОВЕНЬ УГРОЗЫ:** КРИТИЧЕСКИЙ  
**время:** [@timestamp]  
**хост:** [host.name]  
**процесс:** [powershell.exe/cmd.exe/wmic.exe]  
**команда:** [process.command_line]  

**Описание:**

Обнаружено использование PowerShell, cmd.exe или wmic.exe для создания WMI событий и подписок. WMI Event Subscriptions - это мощный persistence механизм, позволяющий выполнять код при срабатывании определённого события (например, при подключении USB устройства). Такие подписки сложно обнаружить и удалить.

**IOC:**
1. Процессы: powershell.exe, pwsh.exe, cmd.exe, wmic.exe
2. Команды: New-WmiEvent, Register-WmiEvent, wmic.exe eventconsumer
3. Использование EventFilter, EventConsumer классов WMI

**Пользователь:** Администратор или атакующий с повышенными привилегиями

**ТЕХНИКА MITRE:** T1546.003 - Event Triggered Execution: WMI Event Subscription

**KQL запрос:**
```lucene
winlog.event_id:1 AND
(process.name:"powershell.exe" OR process.name:"pwsh.exe" OR process.name:"cmd.exe") AND
(process.command_line:"*New-WmiEvent*" OR process.command_line:"*Register-WmiEvent*" OR
 process.command_line:"*wmic.exe*" AND process.command_line:"*eventconsumer*")
```

---

## 23. Network Connection for C2 (TA0003 - Persistence)

**Что произошло:** Мониторинг сетевых соединений из подозрительных процессов на стандартные веб-порты (C2)

**УРОВЕНЬ УГРОЗЫ:** КРИТИЧЕСКИЙ  
**время:** [@timestamp]  
**хост:** [host.name]  
**процесс:** [process.name]  
**целевой адрес:** [destination.ip]  
**целевой порт:** [destination.port]  

**Описание:**

Обнаружено исходящее сетевое соединение из подозрительного процесса на веб-порты. Это может указывать на связь с командным центром (C2 server), загрузку дополнительного вредоноса или утечку данных. Подозрительными процессами являются powershell.exe, cmd.exe, mshta.exe, rundll32.exe, regsvr32.exe.

**IOC:**
1. Процессы: powershell.exe, cmd.exe, mshta.exe, rundll32.exe, regsvr32.exe
2. Порты: 80, 443, 8080, 8443, 8888
3. Направление: outbound
4. Нестандартные целевые адреса

**Пользователь:** Скомпрометированный пользователь, администратор, вредонос

**ТЕХНИКА MITRE:** T1571 - Non-Standard Port

**KQL запрос:**
```lucene
winlog.event_id:3 AND
(source_process.name:"powershell.exe" OR source_process.name:"pwsh.exe" OR source_process.name:"cmd.exe" OR
 source_process.name:"mshta.exe" OR source_process.name:"rundll32.exe" OR source_process.name:"regsvr32.exe") AND
destination.port:(80 OR 443 OR 8080 OR 8443 OR 8888)
```

---

## 24. Process Injection for Persistence (TA0003 - Persistence)

**Что произошло:** Обнаружение внедрения кода в процессы для персистентности

**УРОВЕНЬ УГРОЗЫ:** КРИТИЧЕСКИЙ  
**время:** [@timestamp]  
**хост:** [host.name]  
**исходный процесс:** [source_process.name]  
**целевой процесс:** [target_process.name]  

**Описание:**

Обнаружено внедрение кода в процессы из подозрительного источника (PowerShell, cmd.exe, процессы из Temp/AppData папок). Это позволяет злоумышленнику запустить вредоносный код в контексте другого процесса, скрывая источник атаки и обеспечивая persistence.

**IOC:**
1. CreateRemoteThread из powershell.exe, cmd.exe или процессов из Temp/AppData
2. Целевые процессы: svchost.exe (исключить), explorer.exe (исключить)
3. Использование техник hollowing, atom bombing, и других injection техник

**Пользователь:** Администратор, скомпрометированный пользователь, вредонос

**ТЕХНИКА MITRE:** T1055 - Process Injection

**KQL запрос:**
```lucene
winlog.event_id:8 AND
(source_process.name:"powershell.exe" OR source_process.name:"cmd.exe" OR 
 source_process.path:"*\\Temp\\*" OR source_process.path:"*\\AppData\\*") AND
NOT (target_process.name:"explorer.exe" OR target_process.name:"svchost.exe")
```

---

## 25. Suspicious Registry Operations (TA0003 - Persistence)

**Что произошло:** Обнаружение попыток изменения системных политик и служб через реестр

**УРОВЕНЬ УГРОЗЫ:** ВЫСОКИЙ  
**время:** [@timestamp]  
**хост:** [host.name]  
**путь реестра:** [registry.path]  
**исходный процесс:** [process.name]  

**Описание:**

Обнаружено изменение критичных разделов реестра, связанных с системными политиками и сервисами. Такие изменения часто используются для отключения защиты, создания persistence механизмов или расширения привилегий.

**IOC:**
1. Пути реестра: Software\Microsoft\Windows\CurrentVersion\policies\*, System\CurrentControlSet\Services\*, Software\Policies\*
2. Исходный процесс вне System32
3. Изменение параметров безопасности или запуска сервисов

**Пользователь:** Администратор или атакующий с повышенными привилегиями

**ТЕХНИКА MITRE:** T1548 - Abuse Elevation Control Mechanism

**KQL запрос:**
```lucene
winlog.event_id:12 AND
(registry.path:"*\\Software\\Microsoft\\Windows\\CurrentVersion\\policies\\*" OR
 registry.path:"*\\System\\CurrentControlSet\\Services\\*" OR
 registry.path:"*\\Software\\Policies\\*") AND
NOT process.path:"C:\\Windows\\System32\\*"
```

---

## 26. File Rename/Move for Persistence (TA0003 - Persistence)

**Что произошло:** Обнаружение переименования вредоносных файлов для скрытия их истинного назначения

**УРОВЕНЬ УГРОЗЫ:** СРЕДНИЙ  
**время:** [@timestamp]  
**хост:** [host.name]  
**исходное имя файла:** [previous_filename]  
**новое имя файла:** [file.name]  

**Описание:**

Обнаружено переименование вредоносных файлов (с расширениями .bat, .ps1, .vbs, .exe, .dll) в безобидные расширения (.txt, .tmp, .log, .ini). Это используется для скрытия истинного назначения файла от пользователя и систем защиты. После переименования файл может быть переименован обратно и выполнен.

**IOC:**
1. Исходные расширения: .bat, .ps1, .vbs, .exe, .dll
2. Новые расширения: .txt, .tmp, .log, .ini
3. Переименование из подозрительных процессов

**Пользователь:** Администратор, скомпрометированный пользователь, вредонос

**ТЕХНИКА MITRE:** T1036.004 - Masquerading: Rename System Utilities

**KQL запрос:**
```lucene
winlog.event_id:26 AND
(previous_filename:"*.bat" OR previous_filename:"*.ps1" OR previous_filename:"*.vbs" OR
 previous_filename:"*.exe" OR previous_filename:"*.dll") AND
(file.name:"*.txt" OR file.name:"*.tmp" OR file.name:"*.log" OR file.name:"*.ini")
```

---

## 27. DNS Query for C2 (TA0003 - Persistence)

**Что произошло:** Обнаружение DNS запросов к подозрительным доменам для C2 коммуникации

**УРОВЕНЬ УГРОЗЫ:** КРИТИЧЕСКИЙ  
**время:** [@timestamp]  
**хост:** [host.name]  
**процесс:** [process.name]  
**запрашиваемый домен:** [query_name]  

**Описание:**

Обнаружены DNS запросы из подозрительных процессов к доменам, которые часто используются для C2 коммуникации. Это могут быть случайно сгенерированные доменные имена (DGA), известные C2 домены или подозрительные TLD (.onion, .buzz, .xyz и др.).

**IOC:**
1. Процессы: powershell.exe, cmd.exe, rundll32.exe, regsvr32.exe, mshta.exe
2. Доменные имена: с подозрительными TLD, DGA паттернами
3. Высокая частота DNS запросов к одному домену

**Пользователь:** Скомпрометированный пользователь, администратор, вредонос

**ТЕХНИКА MITRE:** T1071.004 - Application Layer Protocol: DNS

**KQL запрос:**
```lucene
winlog.event_id:22 AND
(source_process.name:"powershell.exe" OR source_process.name:"pwsh.exe" OR source_process.name:"cmd.exe" OR
 source_process.name:"rundll32.exe" OR source_process.name:"regsvr32.exe" OR source_process.name:"mshta.exe") AND
(query_name:/.*\\.(top|buzz|xyz|rest|ml|cf|gq|ga|cyou|quest|onion)/ OR
 dns.question.name:"*dga*" OR dns.question.name:"*c2*" OR dns.question.name:"*malware*")
```

---

## 28. Pipe Created for C2 Communication (TA0003 - Persistence)

**Что произошло:** Обнаружение создания именованных каналов для коммуникации между процессами (в т.ч. C2)

**УРОВЕНЬ УГРОЗЫ:** ВЫСОКИЙ  
**время:** [@timestamp]  
**хост:** [host.name]  
**имя канала:** [pipe_name]  
**исходный процесс:** [source_process.name]  

**Описание:**

Обнаружено создание именованных каналов (Named Pipes) с подозрительными именами. Именованные каналы часто используются для inter-process communication (IPC), включая коммуникацию между локальным процессом и C2 сервером, или для lateral movement в сети.

**IOC:**
1. Имена каналов: содержащие psexec, lsass, mimikatz, mojo и другие подозрительные названия
2. Исходный процесс вне svchost.exe
3. Множественное создание каналов за короткий период

**Пользователь:** Администратор, скомпрометированный пользователь, вредонос

**ТЕХНИКА MITRE:** T1570 - Lateral Tool Transfer

**KQL запрос:**
```lucene
winlog.event_id:17 AND
(pipe_name:"\\\\*\\psexec*" OR pipe_name:"\\\\*\\lsass*" OR 
 pipe_name:"\\\\*\\mimikatz*" OR pipe_name:"\\\\*\\mojo*") AND
NOT source_process.name:"svchost.exe"
```

---

## 29. Suspicious File Deletion (TA0003 - Persistence)

**Что произошло:** Обнаружение удаления файлов резервного копирования для предотвращения восстановления

**УРОВЕНЬ УГРОЗЫ:** КРИТИЧЕСКИЙ  
**время:** [@timestamp]  
**хост:** [host.name]  
**удалённый файл:** [file.name]  
**исходный процесс:** [process.name]  

**Описание:**

Обнаружено удаление файлов резервного копирования (VBK, VIB, VBM, BKF расширения или файлы с recovery, backup, shadow в имени). Это типичное поведение для ransomware, которое удаляет резервные копии для предотвращения восстановления данных.

**IOC:**
1. Расширения: .VBK, .VIB, .VBM, .BKF
2. Имена файлов: содержащие backup, recovery, shadow
3. Исходный процесс не связан с резервным копированием (исключить Backup Exec, Veeam, Veritas)

**Пользователь:** Администратор, skомпрометированный пользователь, ransomware

**ТЕХНИКА MITRE:** T1490 - Inhibit System Recovery

**KQL запрос:**
```lucene
winlog.event_id:23 AND
(file.extension:"VBK" OR file.extension:"VIB" OR file.extension:"VBM" OR file.extension:"BKF" OR
 file.name:"*backup*" OR file.name:"*recovery*" OR file.name:"*shadow*") AND
NOT (process.name:"Backup Exec*" OR process.path:"*\\Veeam\\*" OR process.path:"*\\Veritas\\*")
```

---

# Итоговые рекомендации

1. **Немедленные действия:**
   - Изолировать скомпрометированные хосты от сети
   - Собрать логи Event ID, процессы и файлы на указанные индикаторы
   - Провести анализ памяти процессов (особенно powershell.exe, cmd.exe)

2. **Краткосрочные действия:**
   - Обновить сигнатуры антивирусов и EDR решений
   - Развернуть KQL запросы во всех средах мониторинга
   - Провести проверку всех пользовательских рабочих станций

3. **Долгосрочные действия:**
   - Внедрить SIEM с автоматическим корреляцией событий
   - Обучить пользователей социальной инженерии и фишингу
   - Регулярно обновлять правила обнаружения на основе новых TTP
   - Проводить red team exercices для проверки защиты

---

**Дата создания отчёта:** 2025-12-20  
**Версия:** 1.0  
**Статус:** Актуально